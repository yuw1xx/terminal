<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>SCiPNET // TERMINAL</title>
  
  <meta name="title" content="SCiPNET // TERMINAL">
  <meta name="description" content="Secure Containment Procedures Foundation Database">
  <meta name="theme-color" content="#000000">
  
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' fill='%23ff5555' font-family='monospace' font-size='90'>!</text></svg>">
  
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      /* DEFAULT: EMERALD PHOSPHOR */
      --bg: #050505;
      --term-main: #4af626;  
      --term-dim: #2ea818;
      --term-user: #50fa7b;  
      --term-path: #bd93f9;  
      --term-error: #ff5555; 
      --term-warning: #ffb86c;
      --term-link: #8be9fd;  
      --term-accent: #f1fa8c; 
      --glow: rgba(74, 246, 38, 0.5);
    }

    /* THEME: AMBER */
    body.theme-amber {
      --term-main: #ffb000; --term-dim: #cc8800; --term-user: #ffcc55; 
      --term-path: #ffdd99; --glow: rgba(255, 176, 0, 0.5);
    }

    /* THEME: COBALT */
    body.theme-cobalt {
      --term-main: #0088ff; --term-dim: #0055aa; --term-user: #55aaff; 
      --term-path: #99ccff; --glow: rgba(0, 136, 255, 0.5);
    }

    /* THEME: GHOST (White) */
    body.theme-ghost {
      --term-main: #e2e2dc; --term-dim: #999999; --term-user: #ffffff; 
      --term-path: #cccccc; --glow: rgba(255, 255, 255, 0.4);
    }

    ::selection { background: var(--term-main); color: var(--bg); }

    body, html {
      margin: 0; padding: 0; width: 100%; height: 100%;
      background-color: #000; color: #e2e2dc;
      font-family: 'JetBrains Mono', monospace; font-size: 15px;
      line-height: 1.5; overflow: hidden; user-select: none; 
      perspective: 1000px;
    }

    /* --- HARDWARE SIMULATION & CRT TUBE EFFECT --- */
    #monitor-bezel {
      width: 100vw; height: 100vh; padding: 2vw; box-sizing: border-box;
      background: #020202; display: flex; align-items: center; justify-content: center;
    }

    #screen-glass {
      width: 100%; height: 100%; position: relative;
      background-color: var(--bg); border-radius: 12px; overflow: hidden;
      box-shadow: inset 0 0 50px rgba(0,0,0,0.8), inset 0 0 15px rgba(255,255,255,0.05), 0 0 20px rgba(0,0,0,1);
      animation: textFlicker 0.15s infinite alternate;
      text-shadow: 0 0 3px var(--glow);
      display: flex; flex-direction: column;
      /* Hidden initially for power-on effect */
      transform: scale(0.001, 0.001);
      opacity: 0;
    }

    .power-on {
      animation: crtTurnOn 0.6s cubic-bezier(0.23, 1, 0.32, 1) forwards !important;
    }

    @keyframes crtTurnOn {
      0% { transform: scale(0.01, 0.001); opacity: 1; filter: brightness(10); background: #fff; }
      40% { transform: scale(1, 0.001); opacity: 1; filter: brightness(10); background: #fff; }
      100% { transform: scale(1, 1); opacity: 1; filter: brightness(1); background: var(--bg); }
    }

    @keyframes textFlicker {
      0% { opacity: 0.96; text-shadow: 0 0 2px var(--glow); }
      100% { opacity: 1; text-shadow: 0 0 5px var(--glow); }
    }

    /* --- CRT OVERLAYS & SCANLINES --- */
    .crt-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: 
          linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%),
          linear-gradient(90deg, rgba(255, 0, 0, 0.04), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.04)),
          repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.1) 2px, rgba(0,0,0,0.1) 4px);
      background-size: 100% 4px, 6px 100%, 100% 100%;
      z-index: 100; pointer-events: none;
    }

    .crt-vignette {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: radial-gradient(circle, rgba(0,0,0,0) 50%, rgba(0,0,0,0.95) 100%);
      z-index: 101; pointer-events: none;
      box-shadow: inset 0 0 100px rgba(0,0,0,0.9);
    }

    /* --- GLOBAL STATUS BAR --- */
    #status-bar {
      display: flex; justify-content: space-between; align-items: center;
      padding: 0.4rem 2rem; background: rgba(74, 246, 38, 0.1);
      border-bottom: 1px solid var(--term-main);
      color: var(--term-main); font-weight: bold; font-size: 0.9rem;
      text-transform: uppercase; z-index: 10; letter-spacing: 1px;
      transition: all 0.3s;
    }
    .status-item { display: flex; align-items: center; gap: 0.5rem; }
    .status-blink { animation: slowBlink 2s infinite; }
    @keyframes slowBlink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

    /* --- MAIN TERMINAL --- */
    #terminal-container {
      position: relative; z-index: 10; flex: 1;
      padding: 2rem 3rem; box-sizing: border-box;
      overflow-y: auto; overflow-x: hidden; scroll-behavior: smooth;
      display: flex; flex-direction: column;
    }

    #output { white-space: pre-wrap; word-wrap: break-word; margin-bottom: 0.5rem; }

    .input-line {
      display: flex; align-items: center; flex-wrap: wrap; 
      margin-top: 0.2rem; padding-bottom: 2rem; position: relative;
    }

    .prompt-user { color: var(--term-user); font-weight: bold; text-shadow: 0 0 4px var(--term-user); transition: 0.3s; }
    .prompt-host { color: var(--term-error); font-weight: bold; text-shadow: 0 0 4px var(--term-error); transition: 0.3s; }
    .prompt-path { color: var(--term-path); font-weight: bold; text-shadow: 0 0 4px var(--term-path); transition: 0.3s; }
    .prompt-char { color: var(--term-main); margin-right: 0.8rem; font-weight: bold; transition: 0.3s; }

    #cmd-display { white-space: pre; color: var(--term-main); text-shadow: 0 0 4px var(--term-main); transition: 0.3s; }

    .cursor {
      display: inline-block; width: 0.6em; height: 1.2em;
      background-color: var(--term-main); vertical-align: middle;
      animation: blink 1s step-end infinite; box-shadow: 0 0 6px var(--term-main);
      margin-left: 2px; margin-top: -2px; transition: 0.3s;
    }
    .cursor.typing { animation: none; opacity: 1; }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

    #cmd-input {
      position: fixed; top: -100px; left: -100px;
      opacity: 0; width: 1px; height: 1px; border: none; padding: 0; pointer-events: none; z-index: -1;
    }

    .system-msg { color: var(--term-dim); transition: 0.3s; }
    .error-msg { color: var(--term-error); text-shadow: 0 0 5px var(--term-error); }
    .warning-msg { color: var(--term-warning); text-shadow: 0 0 5px var(--term-warning); }
    .success-msg { color: var(--term-main); text-shadow: 0 0 5px var(--term-main); transition: 0.3s; }
    .key-color { color: var(--term-accent); transition: 0.3s; }
    .redacted { background: #e2e2dc; color: #e2e2dc; text-shadow: none; display: inline-block; }
    
    .glitch-text { animation: glitch 0.1s linear infinite; display: inline-block; }
    .shake-screen { animation: screenShake 0.4s ease-in-out; }

    @keyframes glitch {
      0% { transform: translate(0) }
      20% { transform: translate(-2px, 1px) }
      40% { transform: translate(-1px, -1px) }
      60% { transform: translate(2px, 1px) }
      80% { transform: translate(1px, -1px) }
      100% { transform: translate(0) }
    }

    @keyframes screenShake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px) translateY(2px); }
      20%, 40%, 60%, 80% { transform: translateX(5px) translateY(-2px); }
    }

    .ascii-art {
      font-weight: bold; color: var(--term-error); text-shadow: 0 0 8px var(--term-error);
      margin-bottom: 1.5rem; line-height: 1.2; white-space: pre; font-size: 13px;
    }

    /* --- CCTV FEED STYLING --- */
    .cctv-frame {
      width: 100%; max-width: 500px; height: 280px;
      border: 2px solid var(--term-main); margin: 1rem 0;
      position: relative; overflow: hidden; background: #050505;
      box-shadow: 0 0 15px rgba(0,0,0,0.8), inset 0 0 20px rgba(0,0,0,0.9);
      transition: 0.3s;
    }

    /* Procedurally Generated Canvas Feed */
    .cctv-canvas {
      width: 100%; height: 100%; position: absolute; top: 0; left: 0;
      pointer-events: none; border: none;
      /* Default Emerald Filter applied to pure black & white drawings */
      filter: grayscale(100%) sepia(100%) hue-rotate(70deg) contrast(1.8) brightness(0.8);
    }
    
    /* Adapt procedural canvas filter to match the current terminal theme */
    body.theme-amber .cctv-canvas { filter: grayscale(100%) sepia(100%) hue-rotate(10deg) contrast(1.8) brightness(0.8); }
    body.theme-cobalt .cctv-canvas { filter: grayscale(100%) sepia(100%) hue-rotate(190deg) contrast(1.8) brightness(0.8); }
    body.theme-ghost .cctv-canvas { filter: grayscale(100%) contrast(1.5) brightness(0.9); }
    body.breach-mode .cctv-canvas { filter: grayscale(100%) sepia(100%) hue-rotate(0deg) contrast(2) brightness(0.8) !important; }

    /* Override filters for specific functional cameras that shouldn't match phosphor */
    .cctv-canvas.canvas-thermal { filter: contrast(1.2) brightness(1.2) saturate(1.5) !important; }
    .cctv-canvas.canvas-radar { filter: sepia(100%) hue-rotate(70deg) contrast(2) brightness(1.2) !important; }

    .cctv-static {
      position: absolute; top: -100%; left: -100%; width: 300%; height: 300%;
      /* SVG Filter generates pure TV Static! */
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.5'/%3E%3C/svg%3E");
      animation: staticAnim 0.2s steps(2) infinite;
      opacity: 0.4; mix-blend-mode: screen; pointer-events: none;
    }
    @keyframes staticAnim { 0% { transform: translate(0, 0); } 100% { transform: translate(10%, 10%); } }
    
    .cctv-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      padding: 1rem; box-sizing: border-box; display: flex; flex-direction: column; justify-content: space-between;
      color: #fff; text-shadow: 0 0 5px #000, 0 0 10px var(--term-main); font-weight: bold;
      z-index: 10; font-size: 0.9rem; transition: 0.3s; pointer-events: none;
    }
    .cctv-header { display: flex; justify-content: space-between; }
    .cctv-rec { color: #ff3333; text-shadow: 0 0 5px #ff3333; animation: blink 1.5s infinite; }

    /* --- CONTAINMENT BREACH MODE --- */
    body.breach-mode {
      --term-main: #ff3333 !important; --term-dim: #aa1111 !important; 
      --term-user: #ffaaaa !important; --term-path: #ff6666 !important;
      --glow: rgba(255, 51, 51, 0.7) !important; animation: breachPulse 1.5s infinite;
    }
    body.breach-mode #status-bar { border-bottom-color: var(--term-main); color: var(--term-main); background: rgba(255,51,51,0.2); }
    @keyframes breachPulse { 0%, 100% { background-color: #000; } 50% { background-color: #300000; } }

    /* --- NANO PAGER STYLING --- */
    #nano-view {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background-color: var(--bg); z-index: 200; display: none; flex-direction: column;
      font-family: 'JetBrains Mono', monospace; font-size: 15px; user-select: text; 
    }

    .nano-header, .nano-footer {
      background-color: #e2e2dc; color: var(--bg); padding: 0.3rem 1.5rem;
      display: flex; justify-content: space-between; font-weight: bold; text-shadow: none; flex-shrink: 0; z-index: 10;
    }
    .nano-footer { cursor: pointer; transition: background 0.2s; }
    .nano-footer:hover { background-color: var(--term-main); }

    .nano-content {
      flex: 1; overflow-y: auto; padding: 2rem 3rem; color: #e2e2dc; z-index: 10; position: relative;
    }

    #nano-content p { margin-bottom: 1.2rem; }
    #nano-content table { border-collapse: collapse; margin-bottom: 1.5rem; width: 100%; background: rgba(0,0,0,0.5); }
    #nano-content th, #nano-content td { border: 1px solid var(--term-dim); padding: 0.8rem; }
    
    #nano-content img {
      max-width: 100%; max-height: 500px; border: 2px solid var(--term-main);
      filter: grayscale(100%) sepia(100%) hue-rotate(70deg) brightness(1.2) contrast(1.8);
      opacity: 0.85; margin: 1.5rem 0 0.5rem 0; display: block; box-shadow: 0 0 20px rgba(74, 246, 38, 0.3);
    }

    body.breach-mode #nano-content img {
      filter: grayscale(100%) sepia(100%) hue-rotate(0deg) brightness(1.2) contrast(1.8) !important;
      box-shadow: 0 0 20px rgba(255, 51, 51, 0.3); border-color: var(--term-main);
    }

    #nano-content blockquote {
      border-left: 4px solid var(--term-warning); padding-left: 1.5rem; color: var(--term-warning);
      margin: 2rem 0; background: rgba(255, 184, 108, 0.08); text-shadow: 0 0 3px rgba(255, 184, 108, 0.5);
    }

    #nano-content a { color: var(--term-link); text-decoration: none; border-bottom: 1px dashed var(--term-link); transition: all 0.2s; }
    #nano-content a:hover { background-color: var(--term-link); color: var(--bg); }

    .scp-keyword { color: var(--term-accent); font-weight: bold; text-shadow: 0 0 5px rgba(241, 250, 140, 0.6); }

    /* Matrix Decryption Overlay */
    #decrypt-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: var(--bg); z-index: 50; display: none; flex-direction: column;
      font-size: 1.2rem; overflow: hidden; color: var(--term-main); padding-top: 2rem;
    }
    
    .matrix-column {
      position: absolute; top: -100%;
      font-family: 'JetBrains Mono', monospace; font-size: 1.5rem;
      line-height: 1; text-align: center; color: var(--term-dim);
      text-shadow: 0 0 5px var(--term-main);
      animation: matrixFall linear infinite;
    }
    .matrix-column span:last-child { color: #fff; text-shadow: 0 0 10px #fff, 0 0 20px var(--term-main); }
    
    @keyframes matrixFall {
      0% { transform: translateY(-100%); opacity: 1; }
      100% { transform: translateY(100vh); opacity: 0; }
    }

    ::-webkit-scrollbar { width: 12px; }
    ::-webkit-scrollbar-track { background: var(--bg); border-left: 1px solid rgba(255, 255, 255, 0.05); }
    ::-webkit-scrollbar-thumb { background: rgba(255, 85, 85, 0.5); border-radius: 0px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255, 85, 85, 0.9); }

    @media (max-width: 800px) {
      #monitor-bezel { padding: 0; }
      #screen-glass { border-radius: 0; }
      #status-bar { flex-direction: column; gap: 0.5rem; padding: 0.5rem; font-size: 11px;}
      #terminal-container { padding: 1.5rem 1rem; font-size: 13px; }
      .ascii-art { font-size: 7px; }
      .nano-content { padding: 1rem; font-size: 13px; }
      .nano-header span:nth-child(1), .nano-footer span:nth-child(1), .nano-footer span:nth-child(2) { display: none; }
      .cctv-frame { height: 200px; }
    }
  </style>
</head>
<body>

<!-- INITIALIZE OVERLAY -->
<div id="init-overlay" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#000;color:var(--term-main);display:flex;align-items:center;justify-content:center;font-size:1.5rem;z-index:999;cursor:pointer;font-family:'JetBrains Mono',monospace; text-shadow: 0 0 10px var(--term-main);">
  <span class='cursor'></span> PRESS ANYWHERE TO INITIALIZE SCiPNET
</div>

<div id="monitor-bezel">
  <div id="screen-glass">
    
    <div class="crt-overlay"></div>
    <div class="crt-vignette"></div>

    <!-- STATUS BAR -->
    <div id="status-bar">
      <div class="status-item"><span>SYS:</span> <span class="status-blink" id="status-sys">ONLINE</span></div>
      <div class="status-item"><span>CLEARANCE:</span> <span>O5 (THAUMIEL)</span></div>
      <div class="status-item"><span>MEM:</span> <span id="mem-usage">64TB / 128TB</span></div>
      <div class="status-item"><span>UPLINK:</span> <span id="sys-clock">00:00:00 UTC</span></div>
    </div>

    <!-- NANO PAGER VIEW -->
    <div id="nano-view">
      <div class="nano-header">
        <span>GNU nano 6.2</span>
        <span id="nano-title">File: SCP-XXX.DAT</span>
        <span>Read View</span>
      </div>
      
      <div id="decrypt-overlay">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 100;" class="glitch-text">
          <span style="background: var(--bg); padding: 1rem; border: 2px solid var(--term-main); font-weight: bold; font-size: 2rem; color: var(--term-main);">[ DECRYPTING CLASSIFIED PAYLOAD ]</span>
        </div>
      </div>

      <div class="nano-content" id="nano-content"></div>
      
      <div class="nano-footer" onclick="closePager()">
        <span>^Y Prev Page</span>
        <span>^V Next Page</span>
        <span>[Click Here] or press [Q] / [ESC] to Exit</span>
      </div>
    </div>

    <!-- MAIN TERMINAL -->
    <main id="terminal-container" role="main">
      <div id="output"></div>
      
      <div class="input-line" id="input-line" style="display: none;">
        <span class="prompt">
          <span class="prompt-user">O5-Command</span>@<span class="prompt-host">SCiPNET</span>:<span class="prompt-path">/sys/db/records</span><span class="prompt-char">#</span>
        </span>
        <span id="cmd-display"></span>
        <span class="cursor" id="term-cursor"></span>
        <input type="text" id="cmd-input" autocomplete="off" spellcheck="false" autocapitalize="off" autofocus>
      </div>
    </main>
    
  </div>
</div>

  <script>
    /* =========================================================================
       ANTI-DEVTOOLS & SECURITY PROTOCOLS
       ========================================================================= */
    document.addEventListener('contextmenu', event => event.preventDefault());
    document.addEventListener('keydown', function(e) {
      if(e.key === 'F12' || (e.ctrlKey && e.shiftKey && ['I', 'J', 'C'].includes(e.key)) || (e.ctrlKey && e.key === 'U')) e.preventDefault();
    });
    console.log("%c[ UNAUTHORIZED ACCESS ATTEMPT DETECTED ]", "color: red; font-size: 20px; font-weight: bold;");
    setInterval(function() { (function(a){return(function(a){return(Function('def','debugger'))()})()})() }, 50);

    /* =========================================================================
       ADVANCED AUDIO SYNTHESIZER (Web Audio API)
       ========================================================================= */
    let audioCtx;
    let audioEnabled = false;
    let ambientOsc, ambientGain;
    let sirenOsc, sirenGain, sirenInterval;

    function initAudio() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        audioEnabled = true;
        
        ambientOsc = audioCtx.createOscillator();
        ambientGain = audioCtx.createGain();
        ambientOsc.type = 'sine';
        ambientOsc.frequency.setValueAtTime(55, audioCtx.currentTime); 
        ambientGain.gain.setValueAtTime(0.015, audioCtx.currentTime); 
        ambientOsc.connect(ambientGain);
        ambientGain.connect(audioCtx.destination);
        ambientOsc.start();
      }
      if (audioCtx.state === 'suspended') audioCtx.resume();
    }

    function playSound(type) {
      if (!audioEnabled || !audioCtx) return;
      const osc = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();
      osc.connect(gainNode); gainNode.connect(audioCtx.destination);
      const now = audioCtx.currentTime;
      
      if (type === 'type') {
        osc.type = 'square';
        osc.frequency.setValueAtTime(120 + Math.random() * 60, now);
        gainNode.gain.setValueAtTime(0.015, now);
        gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
        osc.start(now); osc.stop(now + 0.05);
      } else if (type === 'enter') {
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(90, now);
        gainNode.gain.setValueAtTime(0.04, now);
        gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
        osc.start(now); osc.stop(now + 0.1);
      } else if (type === 'error') {
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(50, now);
        gainNode.gain.setValueAtTime(0.08, now);
        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
        osc.start(now); osc.stop(now + 0.3);
      } else if (type === 'success') {
        osc.type = 'sine';
        osc.frequency.setValueAtTime(800, now);
        osc.frequency.exponentialRampToValueAtTime(1500, now + 0.15);
        gainNode.gain.setValueAtTime(0.03, now);
        gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
        osc.start(now); osc.stop(now + 0.2);
      } else if (type === 'poweron') {
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(20, now);
        osc.frequency.exponentialRampToValueAtTime(200, now + 0.5);
        gainNode.gain.setValueAtTime(0.1, now);
        gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.8);
        osc.start(now); osc.stop(now + 0.8);
      }
    }

    function toggleSiren(active) {
      if (!audioEnabled || !audioCtx) return;
      if (active) {
        if(sirenOsc) return;
        sirenOsc = audioCtx.createOscillator();
        sirenGain = audioCtx.createGain();
        sirenOsc.type = 'square';
        sirenOsc.connect(sirenGain);
        sirenGain.connect(audioCtx.destination);
        sirenGain.gain.setValueAtTime(0.02, audioCtx.currentTime);
        sirenOsc.start();
        
        let up = true;
        sirenInterval = setInterval(() => {
          sirenOsc.frequency.linearRampToValueAtTime(up ? 800 : 400, audioCtx.currentTime + 1);
          up = !up;
        }, 1000);
      } else {
        if(sirenOsc) {
          sirenOsc.stop(); sirenOsc.disconnect();
          clearInterval(sirenInterval); sirenOsc = null;
        }
      }
    }

    /* =========================================================================
       STATUS BAR LOGIC
       ========================================================================= */
    setInterval(() => {
      document.getElementById('sys-clock').innerText = new Date().toISOString().replace('T', ' ').substring(0, 19) + ' UTC';
      let memBase = 64;
      let flux = (Math.random() * 2 - 1).toFixed(2);
      document.getElementById('mem-usage').innerText = `${(memBase + parseFloat(flux)).toFixed(2)}TB / 128.00TB`;
    }, 1000);

    /* =========================================================================
       TERMINAL LOGIC & PROCEDURAL CANVAS ENGINE
       ========================================================================= */
    const output = document.getElementById('output');
    const inputLine = document.getElementById('input-line');
    const cmdDisplay = document.getElementById('cmd-display');
    const inputField = document.getElementById('cmd-input');
    const terminalContainer = document.getElementById('terminal-container');
    const cursorEl = document.getElementById('term-cursor');
    const nanoView = document.getElementById('nano-view');
    const nanoContent = document.getElementById('nano-content');
    const decryptOverlay = document.getElementById('decrypt-overlay');

    let commandHistory = [];
    let historyIndex = -1;
    let inPager = false;
    let typingTimer;
    let isBreach = false;

    const activeCameras = [];
    function renderCameras() {
      activeCameras.forEach(cam => {
        const {ctx, w, h, type, state} = cam;
        cam.frame++;
        ctx.clearRect(0, 0, w, h);
        
        if (type === '01') { 
            ctx.fillStyle = '#050505'; ctx.fillRect(0, 0, w, h);
            ctx.fillStyle = '#ffffff';
            state.stars.forEach(s => {
               ctx.beginPath(); ctx.arc(s.x, s.y, s.size, 0, Math.PI*2); ctx.fill();
               s.x -= s.speed; if(s.x < 0) s.x = w;
            });
            const earthY = h - 30; const earthR = 600;
            ctx.beginPath(); ctx.arc(w/2, earthY + earthR, earthR, 0, Math.PI*2);
            ctx.lineWidth = 4; ctx.fillStyle = '#111111'; ctx.fill();
            ctx.strokeStyle = '#ffffff'; ctx.stroke();
            state.satX += 1; if(state.satX > w + 100) state.satX = -100;
            ctx.fillStyle = '#888888'; ctx.fillRect(state.satX, 50, 10, 4);

        } else if (type === '02') { 
            ctx.fillStyle = '#0a0a0a'; ctx.fillRect(0,0,w,h);
            ctx.strokeStyle = '#aaaaaa'; ctx.lineWidth = 1;
            state.bubbles.forEach(b => {
                ctx.beginPath(); ctx.arc(b.x, b.y, b.s, 0, Math.PI*2); ctx.stroke();
                b.y -= b.v; if(b.y < -10) { b.y = h+10; b.x = Math.random()*w; }
                b.x += Math.sin(cam.frame/20 + b.v) * 0.5;
            });
            state.entityX += 0.4; if(state.entityX > w + 200) state.entityX = -300;
            ctx.fillStyle = '#000000'; ctx.beginPath();
            ctx.ellipse(state.entityX, h/2 + Math.sin(cam.frame/50)*30, 120, 30, 0, 0, Math.PI*2);
            ctx.fill();

        } else if (type === '03') { 
            ctx.fillStyle = '#080808'; ctx.fillRect(0,0,w,h);
            ctx.strokeStyle = '#555555'; ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(0,0); ctx.lineTo(w/2-40, h/2-30); ctx.moveTo(w,0); ctx.lineTo(w/2+40, h/2-30);
            ctx.moveTo(0,h); ctx.lineTo(w/2-40, h/2+30); ctx.moveTo(w,h); ctx.lineTo(w/2+40, h/2+30);
            ctx.stroke(); ctx.strokeRect(w/2-40, h/2-30, 80, 60);

            if (Math.random() > 0.99) state.spookFrame = Math.floor(Math.random() * 10) + 5;
            if (state.spookFrame > 0) {
               ctx.fillStyle = '#000000'; let scale = Math.random() > 0.8 ? 2 : 1;
               ctx.fillRect(w/2 - (10*scale), h/2 - (5*scale), 20*scale, 35*scale);
               state.spookFrame--;
            }
            if (Math.random() > 0.92) { ctx.fillStyle = 'rgba(255,255,255,0.2)'; ctx.fillRect(0,0,w,h); }

        } else if (type === '05') { 
            ctx.fillStyle = '#000044'; ctx.fillRect(0,0,w,h);
            state.blobs.forEach(b => {
                let grad = ctx.createRadialGradient(b.x, b.y, 0, b.x, b.y, b.r);
                grad.addColorStop(0, 'rgba(255, 255, 255, 1)');
                grad.addColorStop(0.2, 'rgba(255, 0, 0, 0.8)');
                grad.addColorStop(0.5, 'rgba(255, 255, 0, 0.4)');
                grad.addColorStop(1, 'rgba(0, 0, 0, 0)');
                ctx.fillStyle = grad;
                ctx.beginPath(); ctx.arc(b.x, b.y, b.r, 0, Math.PI*2); ctx.fill();
                b.x += b.vx; b.y += b.vy;
                if(b.x<0||b.x>w) b.vx*=-1; if(b.y<0||b.y>h) b.vy*=-1;
            });

        } else if (type === '06') { 
            ctx.fillStyle = '#0a0a0a'; ctx.fillRect(0,0,w,h);
            ctx.strokeStyle = 'rgba(255,255,255,0.7)'; ctx.lineWidth = 2;
            state.cells.forEach(c => {
                ctx.beginPath();
                for(let i=0; i<Math.PI*2; i+=0.4) {
                    let r = c.r + Math.sin(cam.frame/10 + i)*4;
                    let px = c.x + Math.cos(i)*r; let py = c.y + Math.sin(i)*r;
                    if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
                }
                ctx.closePath(); ctx.stroke();
                ctx.fillStyle = 'rgba(255,255,255,0.3)';
                ctx.beginPath(); ctx.arc(c.x + Math.sin(cam.frame/5)*2, c.y, c.r/3, 0, Math.PI*2); ctx.fill();
                c.x += c.vx; c.y += c.vy;
                if(c.x<0||c.x>w) c.vx*=-1; if(c.y<0||c.y>h) c.vy*=-1;
            });

        } else if (type === '07') { 
            ctx.fillStyle = 'rgba(0,20,0,0.1)'; ctx.fillRect(0,0,w,h);
            ctx.strokeStyle = '#00ff00'; ctx.lineWidth = 1;
            let cx = w/2, cy = h/2, maxR = Math.min(w,h)/2 - 10;
            
            for(let r=maxR/4; r<=maxR; r+=maxR/4) { ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.stroke(); }
            ctx.beginPath(); ctx.moveTo(cx-maxR,cy); ctx.lineTo(cx+maxR,cy); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(cx,cy-maxR); ctx.lineTo(cx,cy+maxR); ctx.stroke();
            
            let angle = cam.frame / 25;
            ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(cx+Math.cos(angle)*maxR, cy+Math.sin(angle)*maxR); ctx.lineWidth=2; ctx.stroke();
            
            ctx.fillStyle = '#00ff00';
            state.blips.forEach(b => {
                let dx = b.x-cx, dy = b.y-cy;
                let bAngle = Math.atan2(dy, dx);
                if (bAngle < 0) bAngle += Math.PI*2;
                let sweep = angle % (Math.PI*2);
                if (Math.abs(sweep - bAngle) < 0.1) b.life = 1.0; 
                
                if (b.life > 0) {
                    ctx.globalAlpha = b.life;
                    ctx.beginPath(); ctx.arc(b.x, b.y, 4, 0, Math.PI*2); ctx.fill();
                    b.life -= 0.02; ctx.globalAlpha = 1.0;
                }
            });
        }
      });
      requestAnimationFrame(renderCameras);
    }
    requestAnimationFrame(renderCameras);

    function escapeHTML(str) {
      return str.replace(/[&<>'"]/g, tag => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;' }[tag] || tag));
    }

    function getPromptHTML() {
      return `<span class="prompt-user">O5-Command</span>@<span class="prompt-host">SCiPNET</span>:<span class="prompt-path">/sys/db/records</span><span class="prompt-char">#</span>`;
    }

    function closePager() {
      nanoView.style.display = 'none';
      nanoContent.innerHTML = '';
      inPager = false;
      printHTML(`<span class="system-msg">>> EOF. Buffer cleared.</span>`);
      inputField.focus({preventScroll: true});
    }

    async function runDecryptionSequence() {
      decryptOverlay.style.display = 'block';
      nanoContent.style.opacity = '0';
      Array.from(decryptOverlay.querySelectorAll('.matrix-column')).forEach(e => e.remove());

      const columns = Math.floor(window.innerWidth / 20);
      const chars = "0123456789ABCDEF!@#$*&^%█▓▒░";
      let intervals = [];

      for(let i=0; i<columns; i++) {
        let col = document.createElement('div');
        col.className = 'matrix-column';
        col.style.left = (i * 20) + 'px';
        col.style.animationDuration = (Math.random() * 1.5 + 0.5) + 's';
        col.style.animationDelay = (Math.random() * 2) + 's';
        
        let updateInterval = setInterval(() => {
          let str = "";
          let len = Math.floor(Math.random() * 15) + 5;
          for(let j=0; j<len; j++) str += `<span>${chars.charAt(Math.floor(Math.random() * chars.length))}</span><br>`;
          col.innerHTML = str;
        }, 100);
        intervals.push(updateInterval);
        decryptOverlay.appendChild(col);
      }

      playSound('success');
      await new Promise(r => setTimeout(r, 1800)); 
      
      intervals.forEach(clearInterval);
      decryptOverlay.style.display = 'none';
      nanoContent.style.opacity = '1';
    }

    // --- COMMAND DEFINITIONS ---
    const commands = {
      help: {
        action: () => {
          const helpStr = `
<span class="success-msg">[ SCiPNET AUTHORIZED EXECUTABLES ]</span>
  <span class="key-color">scp [ID]</span>     Fetch dossier for exact designation (e.g. scp 096)
  <span class="key-color">random</span>       Initialize randomized database query
  <span class="key-color">map</span>          Initialize active global node traceroute
  <span class="key-color">track [ID]</span>   Connect to deep-space orbital tracking array
  <span class="key-color">cctv [CAM]</span>   Access secure facility camera feeds (Available IDs: 01, 02, 03, 05, 06, 07)
  <span class="key-color">theme [NAME]</span> Recalibrate phosphor display (emerald, amber, cobalt, ghost)
  <span class="key-color">redact [T]</span>   Process plaintext [T] through memetic scrubbers
  <span class="key-color">whoami</span>       Identify current session privileges
  <span class="key-color">reboot</span>       Restart SCiPNET terminal connection
  <span class="key-color">clear</span>        Purge display buffer
  <span class="error-msg glitch-text">breach</span>       [DATA EXPUNGED] DO NOT EXECUTE
`;
          printHTML(helpStr.trim());
        }
      },
      theme: {
        action: (args) => {
          const t = args[0] ? args[0].toLowerCase() : '';
          const valid = ['emerald', 'amber', 'cobalt', 'ghost'];
          if (!valid.includes(t)) {
            playSound('error'); printHTML(`<span class="error-msg">ERROR: INVALID THEME. AVAILABLE: ${valid.join(', ')}</span>`); return;
          }
          document.body.className = '';
          if (t !== 'emerald') document.body.classList.add(`theme-${t}`);
          playSound('success'); printHTML(`<span class="success-msg">>> DISPLAY PHOSPHOR RECALIBRATED TO: ${t.toUpperCase()}</span>`);
        }
      },
      cctv: {
        action: async (args) => {
          let camId = args[0] ? args[0].toUpperCase() : 'UNKNOWN';
          playSound('type');
          printHTML(`<span class="system-msg">>> CONNECTING TO SECURE FEED: CAM-${camId}...</span>`);
          await new Promise(r => setTimeout(r, 1200));
          
          let type = ''; let camStatus = "ONLINE"; let location = "UNKNOWN SECTOR"; let extraClass = '';

          if (camId === '01' || camId === 'SPACE') { type = '01'; location = "ORBITAL ARRAY"; }
          else if (camId === '02' || camId === 'OCEAN') { type = '02'; location = "AQUATIC CONTAINMENT"; }
          else if (camId === '03' || camId === 'CITY' || camId === 'CORRIDOR') { type = '03'; location = "SECTOR 4 [HALLWAY]"; }
          else if (camId === '05' || camId === 'THERMAL') { type = '05'; location = "BIOMETRIC SCANNER"; extraClass = 'canvas-thermal'; }
          else if (camId === '06' || camId === 'MICRO' || camId === 'BIO') { type = '06'; location = "HAZMAT LAB 02"; }
          else if (camId === '07' || camId === 'RADAR') { type = '07'; location = "SECTOR 7 AIRSPACE"; extraClass = 'canvas-radar'; }
          else if (camId === '04' || camId === 'STATIC') { type = '04'; camStatus = "CONNECTION LOST"; location = "HEAVY CONTAINMENT"; }
          else {
             const types = ['01', '02', '03', '04', '05', '06', '07'];
             type = types[Math.floor(Math.random() * types.length)];
             if(type === '04') camStatus = "CONNECTION LOST";
             if(type === '05') extraClass = 'canvas-thermal';
             if(type === '07') extraClass = 'canvas-radar';
          }

          if(type === '04') playSound('error'); else playSound('success');

          const frameId = `cam-${Date.now()}`; const canvasId = `cvs-${Date.now()}`;
          
          printHTML(`
            <div class="cctv-frame">
              ${type !== '04' ? `<canvas id="${canvasId}" width="500" height="280" class="cctv-canvas ${extraClass}"></canvas>` : ''}
              <div class="cctv-static" style="opacity: ${type !== '04' ? '0.15' : '0.4'};"></div>
              <div class="cctv-overlay">
                <div class="cctv-header"><span>CAM-${camId} // ${camStatus}</span><span class="cctv-rec">● REC</span></div>
                ${type === '04' ? `<div style="font-size: 2rem; align-self: center; text-align: center;" class="glitch-text">CONNECTION LOST<br><span style="font-size:1rem;">${location}</span></div>` : '<div></div>'}
                <div style="display: flex; justify-content: space-between;">
                  <span style="color:var(--term-warning);">${type === '04' ? 'WARN: COGNITOHAZARD FILTERS OFFLINE' : 'LOC: ' + location}</span>
                  <span id="${frameId}-time"></span>
                </div>
              </div>
            </div>
          `);
          
          if (type !== '04') {
             const cvs = document.getElementById(canvasId); const ctx = cvs.getContext('2d');
             let state = {};
             if (type === '01') {
                state.stars = Array.from({length: 80}, () => ({x: Math.random()*500, y: Math.random()*280, size: Math.random()*1.5+0.5, speed: Math.random()*0.3+0.1}));
                state.satX = -100;
             } else if (type === '02') {
                state.bubbles = Array.from({length: 40}, () => ({x: Math.random()*500, y: Math.random()*280, s: Math.random()*3+1, v: Math.random()*1.5+0.5}));
                state.entityX = -200;
             } else if (type === '03') {
                state.spookFrame = 0;
             } else if (type === '05') { 
                state.blobs = Array.from({length: 5}, () => ({
                   x: Math.random()*500, y: Math.random()*280, r: Math.random()*60 + 40, vx: (Math.random()-0.5)*2, vy: (Math.random()-0.5)*2
                }));
             } else if (type === '06') { 
                state.cells = Array.from({length: 8}, () => ({
                   x: Math.random()*500, y: Math.random()*280, r: Math.random()*20 + 15, vx: (Math.random()-0.5)*1, vy: (Math.random()-0.5)*1
                }));
             } else if (type === '07') { 
                state.blips = Array.from({length: 6}, () => ({
                   x: Math.random()*400 + 50, y: Math.random()*200 + 40, life: 0
                }));
             }
             activeCameras.push({ ctx, w: 500, h: 280, type, state, frame: 0 });
          }

          setInterval(() => {
              const el = document.getElementById(`${frameId}-time`);
              if(el) el.innerText = new Date().toISOString().substring(11, 19);
          }, 1000);
          scrollToBottom();
        }
      },
      whoami: {
        action: () => printHTML(`<span class="warning-msg">SESSION:</span> O5-Command\n<span class="warning-msg">CLEARANCE:</span> LEVEL 5 (THAUMIEL)\n<span class="warning-msg">LOCATION:</span> SITE-19 MAINFRAME`)
      },
      reboot: { action: async () => { output.innerHTML = ''; activeCameras.length = 0; await runBootSequence(false); } },
      clear: { action: () => { output.innerHTML = ''; activeCameras.length = 0; } },
      redact: {
        action: (args) => {
          if(!args.length) { printHTML("<span class='error-msg'>ERROR: NO TEXT PROVIDED.</span>"); return; }
          const text = args.join(' '); const redacted = text.replace(/[a-zA-Z0-9]/g, '█');
          printHTML(`<span class="system-msg">PROCESSING MEMETIC SCRUB...</span>\n<span class="success-msg">OUTPUT:</span> ${redacted}`);
        }
      },
      map: {
        action: async () => {
          printHTML(`<span class="system-msg">>> INITIATING GLOBAL NODE TRACEROUTE...</span><br><br>`);
          
          const nodes = [
            { id: 'NA-19', region: 'NORTH AMERICA', status: 'ONLINE', cls: 'success-msg', ping: '12ms' },
            { id: 'EU-11', region: 'EUROPE', status: 'ONLINE', cls: 'success-msg', ping: '28ms' },
            { id: 'AS-07', region: 'ASIA', status: 'ONLINE', cls: 'success-msg', ping: '45ms' },
            { id: 'AN-14', region: 'ANTARCTICA', status: 'QUARANTINED', cls: 'warning-msg', ping: '---' },
            { id: 'LU-32', region: 'LUNAR-AREA-32', status: 'ACTIVE', cls: 'success-msg', ping: '1250ms' },
            { id: 'UK-13', region: 'UNKNOWN (SITE-13)', status: 'OFFLINE', cls: 'error-msg', ping: 'TIMEOUT' }
          ];

          for (const node of nodes) {
            playSound('type');
            let baseStr = `> Uplink to ${node.id} [${node.region}] `;
            let dotCount = Math.max(2, 45 - baseStr.length);
            let dots = '.'.repeat(dotCount);
            
            let lineId = `trace-${Date.now()}-${node.id}`;
            printHTML(`<div id="${lineId}" class="key-color" style="margin-bottom: 0.2rem;">${escapeHTML(baseStr)}<span class="system-msg">${dots}</span> <span class="glitch-text">AWAITING RESPONSE</span></div>`);
            
            await new Promise(r => setTimeout(r, 400 + Math.random() * 500));
            
            let el = document.getElementById(lineId);
            if (el) {
               if(node.status === 'OFFLINE' || node.status === 'QUARANTINED') playSound('error');
               else playSound('success');
               
               // Keep status texts aligned perfectly using spaces
               let statusText = `[ ${node.status} ]`;
               let paddedStatus = statusText.padEnd(17, ' '); 
               
               el.innerHTML = `${escapeHTML(baseStr)}<span class="system-msg">${dots}</span> <span class="${node.cls}">${paddedStatus}</span> <span class="system-msg">${node.ping}</span>`;
            }
          }
          
          await new Promise(r => setTimeout(r, 400));
          
          let summary = `
<div style="margin-top: 1rem; padding: 1rem; border: 1px dashed var(--term-main); background: rgba(74, 246, 38, 0.05); display: flex; gap: 3rem; align-items: center; max-width: fit-content;">
  <div>
    <div style="color: var(--term-accent); font-weight: bold; margin-bottom: 0.5rem;">[ NETWORK OVERVIEW ]</div>
    <div><span class="system-msg">TOTAL NODES:</span> 6</div>
    <div><span class="system-msg">ACTIVE SITES:</span> <span class="success-msg">4</span></div>
    <div><span class="system-msg">QUARANTINE:</span> <span class="warning-msg">1</span></div>
    <div><span class="system-msg">LOST CONTACT:</span> <span class="error-msg">1</span></div>
  </div>
  <div class="system-msg" style="white-space: pre; font-size: 0.8rem; line-height: 1.1; font-weight: bold;">
   ....--.        _  
  /       \\_.-'  / 
  \\__   __\\     _ \\ 
     \\ /   \\_\\ / \\_\\
      "      ""   "
  </div>
</div>`;
          printHTML(summary);
          printHTML(`<br><span class="warning-msg">>> TRACEROUTE COMPLETE. 1 ANOMALOUS NODE DETECTED.</span>`);
        }
      },
      track: {
        action: async (args) => {
          if(!args[0]) { printHTML("<span class='error-msg'>ERROR: ENTITY ID REQUIRED.</span>"); return; }
          const id = args[0].toUpperCase();
          printHTML(`<span class="system-msg">>> ALIGNING ORBITAL TRACKING SENSORS TO ENTITY: ${id}...</span>`);
          await new Promise(r => setTimeout(r, 1000));
          
          let trackerID = `tracker-${Date.now()}`;
          printHTML(`<div id="${trackerID}" style="border: 1px solid var(--term-main); padding: 1rem; margin-top: 0.5rem; transition: 0.3s;">
            <div style="font-weight: bold; color: var(--term-warning); margin-bottom: 0.5rem;">[ LIVE SATELLITE TELEMETRY - ${id} ]</div>
            <div>LATITUDE:  <span id="${trackerID}-lat" class="key-color">CALCULATING...</span></div>
            <div>LONGITUDE: <span id="${trackerID}-lon" class="key-color">CALCULATING...</span></div>
            <div>VELOCITY:  <span id="${trackerID}-vel" class="key-color">CALCULATING...</span></div>
            <div style="margin-top: 0.5rem;" class="glitch-text error-msg" id="${trackerID}-status">AWAITING LOCK...</div>
          </div>`);
          scrollToBottom();

          let latBase = (Math.random() * 180 - 90);
          let lonBase = (Math.random() * 360 - 180);
          
          let updates = 0;
          let trackInterval = setInterval(() => {
            const elLat = document.getElementById(`${trackerID}-lat`);
            if(!elLat) { clearInterval(trackInterval); return; } // Cleared
            
            latBase += (Math.random() * 0.001 - 0.0005);
            lonBase += (Math.random() * 0.001 - 0.0005);
            let vel = (Math.random() * 120).toFixed(2);
            
            elLat.innerText = latBase.toFixed(6) + "°";
            document.getElementById(`${trackerID}-lon`).innerText = lonBase.toFixed(6) + "°";
            document.getElementById(`${trackerID}-vel`).innerText = vel + " km/h";
            
            updates++;
            if(updates > 5) document.getElementById(`${trackerID}-status`).innerText = "LOCK ACQUIRED. TRACKING ACTIVE.";
            if(updates > 30) {
                document.getElementById(`${trackerID}-status`).innerHTML = "<span class='error-msg'>SIGNAL LOST. TARGET SUBTERRANEAN OR DESTROYED.</span>";
                clearInterval(trackInterval);
            }
          }, 500);
        }
      },
      breach: {
        action: async () => {
          if (isBreach) return;
          isBreach = true;
          document.body.classList.add('breach-mode');
          document.getElementById('status-sys').innerText = "CRITICAL";
          toggleSiren(true);
          printHTML(`<span class="error-msg glitch-text" style="font-size:2rem; line-height:1;">!!! MULTIPLE EUCLID/KETER CLASS CONTAINMENT BREACHES DETECTED !!!</span>`);
          printHTML(`<span class="error-msg">>> INITIATING SITE-WIDE LOCKDOWN.</span>`);
          printHTML(`<span class="system-msg">Type 'secure' to override lockdown protocols.</span>`);
        }
      },
      secure: {
        action: () => {
          if (!isBreach) { printHTML(`<span class="system-msg">Site is currently secure.</span>`); return; }
          isBreach = false;
          document.body.classList.remove('breach-mode');
          document.getElementById('status-sys').innerText = "ONLINE";
          toggleSiren(false);
          playSound('success');
          printHTML(`<span class="success-msg">>> OVERRIDE ACCEPTED. ALARMS DEACTIVATED. DISPATCHING MTF EPSILON-11.</span>`);
        }
      },
      scp: {
        action: async (args) => {
          let itemNum = "";
          if (args[0] && args[0].toLowerCase() === 'random') {
            itemNum = String(Math.floor(Math.random() * 7999) + 2).padStart(3, '0');
            printHTML(`<span class="system-msg">>> RANDOM QUERY SELECTED: SCP-${itemNum}</span>`);
          } else if (args[0]) {
            itemNum = args[0].toLowerCase().replace(/^scp-/, ''); 
            if (/^\d+$/.test(itemNum) && itemNum.length < 3) itemNum = itemNum.padStart(3, '0');
          }

          if (!itemNum) {
            playSound('error'); printHTML("<span class='error-msg'>ERROR: REQUIRED PARAMETER [ITEM NUMBER] MISSING.</span>");
            document.body.classList.add('shake-screen'); setTimeout(() => document.body.classList.remove('shake-screen'), 400); return;
          }

          printHTML(`<div id="loading-scp" class="system-msg">ESTABLISHING FOUNDATION UPLINK [SCP-${itemNum.toUpperCase()}]... <span class="cursor" style="height: 0.8em; width: 0.4em;"></span></div>`);
          
          try {
            const url = `https://scp-wiki.wikidot.com/scp-${itemNum}`;
            const fetchUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
            const response = await fetch(fetchUrl);
            const data = await response.json();
            
            const parser = new DOMParser();
            const doc = parser.parseFromString(data.contents, 'text/html');
            const pageContent = doc.querySelector('#page-content');
            document.getElementById('loading-scp')?.remove();

            if (!pageContent || pageContent.textContent.includes("This page doesn't exist yet") || doc.title.includes("Error")) {
              playSound('error');
              printHTML(`<span class="error-msg">>> DATABASE ERROR: SCP-${itemNum.toUpperCase()} NOT FOUND OR CLASSIFIED LEVEL 5.</span>`);
              document.body.classList.add('shake-screen'); setTimeout(() => document.body.classList.remove('shake-screen'), 400); return;
            }

            pageContent.querySelectorAll('.page-rate-widget-box, .creditRate, #toc, .info-container, .footer-wikiwalk-nav, .wikiwalk-nav').forEach(el => el.remove());
            Array.from(pageContent.children).forEach(el => {
              if (el.textContent.includes('«') && el.textContent.includes('»') && el.textContent.includes('SCP-')) el.remove();
            });

            pageContent.querySelectorAll('img').forEach(img => {
              let src = img.getAttribute('src');
              if (src && src.startsWith('/')) img.src = 'https://scp-wiki.wikidot.com' + src; 
            });

            pageContent.querySelectorAll('a').forEach(a => {
              let href = a.getAttribute('href');
              if (href && href.startsWith('/')) a.href = 'https://scp-wiki.wikidot.com' + href;
              a.target = '_blank';
            });

            let finalHtml = pageContent.innerHTML;
            finalHtml = finalHtml.replace(/(Item #:|Object Class:|Special Containment Procedures:|Description:|Addendum.*?:)/g, '<span class="scp-keyword">$1</span>');

            document.getElementById('nano-title').textContent = `File: SCP-${itemNum.toUpperCase()}`;
            nanoContent.innerHTML = finalHtml;
            nanoView.style.display = 'flex';
            inPager = true;
            
            await runDecryptionSequence();

          } catch (err) {
            document.getElementById('loading-scp')?.remove();
            playSound('error'); printHTML(`<span class="error-msg">>> NETWORK INTERFERENCE. CONNECTION TO FOUNDATION LOST.</span>`);
            document.body.classList.add('shake-screen'); setTimeout(() => document.body.classList.remove('shake-screen'), 400);
          }
        }
      }
    };

    const aliases = { 'cls': 'clear', 'fetch': 'scp', 'random': 'scp random', 'camera': 'cctv' };

    function scrollToBottom() {
      terminalContainer.scrollTop = terminalContainer.scrollHeight;
      requestAnimationFrame(() => terminalContainer.scrollTop = terminalContainer.scrollHeight);
    }

    function printText(text, className = '') {
      const el = document.createElement('div'); if (className) el.className = className;
      el.textContent = text; output.appendChild(el); scrollToBottom();
    }

    function printHTML(html, className = '') {
      const el = document.createElement('div'); if (className) el.className = className;
      el.innerHTML = html; output.appendChild(el); scrollToBottom();
    }

    // --- IMMERSIVE BOOT SEQUENCE ---
    const bootText = [
      { text: "SCiPNET OS v. 8.2.4 [O5 COMMAND INITIALIZATION]", delay: 200 },
      { text: "Establishing secure connection to Site-19...", delay: 300 },
      { text: "> Node 1: 104.28.██.██ [US-E] - SUCCESS", delay: 100 },
      { text: "> Node 2: 185.17.██.██ [EU-W] - SUCCESS", delay: 100 },
      { text: "> Node 3: SITE-19 MAINFRAME - SUCCESS", delay: 200 },
      { text: " ", delay: 100 },
      { text: "Bypassing biometric constraints...", delay: 300 },
      { text: "<span class='success-msg'>[ OK ]</span> Voiceprint spoofed.", delay: 150 },
      { text: "<span class='success-msg'>[ OK ]</span> Retinal scan bypassed.", delay: 150 },
      { text: " ", delay: 100 },
      { text: "<span class='warning-msg glitch-text'>WARNING: MEMETIC KILL AGENT DETECTED IN LOGIN SEQUENCE.</span>", delay: 800 },
      { type: "memetic", delay: 800 },
      { text: "Deploying counter-memetic inoculation...", delay: 600 },
      { text: "Injecting payload: <span class='glitch-text'>[FRACTAL_SHIELD_V4]</span>", delay: 400 },
      { text: "0x00A1: 4B 49 4C 4C 20 41 47 45 4E 54", delay: 40 },
      { text: "0x00B2: 4E 45 55 54 52 41 4C 49 5A 45", delay: 40 },
      { text: "<span class='success-msg'>[ OK ]</span> Memetic hazard neutralized.", delay: 300 },
      { text: " ", delay: 100 },
      { text: "Mounting encrypted volatile memory...", delay: 400 },
      { text: "<span class='success-msg'>[ OK ]</span> Mounted /dev/mapper/scp-db", delay: 200 },
      { text: " ", delay: 100 },
      { type: "progress", duration: 1000 },
      { text: " ", delay: 100 },
      { text: "<span class='success-msg'>[ OK ]</span> Database decryption complete.", delay: 400 },
      { text: " ", delay: 200 }
    ];

    async function runBootSequence(initial = true) {
      inputLine.style.display = 'none';
      
      if(initial) {
         playSound('poweron');
         document.getElementById('screen-glass').classList.add('power-on');
         await new Promise(r => setTimeout(r, 600)); // wait for CRT turn on
      }

      for (const log of bootText) {
        if (log.type === 'progress') {
          const el = document.createElement('div'); el.className = 'system-msg'; output.appendChild(el);
          let chars = ['-', '\\', '|', '/']; let i = 0; let startTime = Date.now();
          await new Promise(resolve => {
            let interval = setInterval(() => {
              let elapsed = Date.now() - startTime;
              let percent = Math.min(100, Math.floor((elapsed / log.duration) * 100));
              let bars = Math.floor(percent / 5); let barStr = '#'.repeat(bars).padEnd(20, ' ');
              el.innerHTML = `Downloading SCiPNET index... [${barStr}] ${percent}% ${percent < 100 ? chars[i++ % chars.length] : ''}`;
              if (percent % 10 === 0) playSound('type');
              scrollToBottom();
              if (percent >= 100) { clearInterval(interval); resolve(); }
            }, 40);
          });
        } else if (log.type === 'memetic') {
            playSound('error'); document.body.classList.add('shake-screen');
            const mkAgent = `
<span class="error-msg glitch-text" style="font-size: 8px; line-height: 8px;">
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@/'''''''''''''''''''''''''''\\@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@/  /\\  /\\  /\\  /\\  /\\  /\\  /\\ \\@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@/  /  \\/  \\/  \\/  \\/  \\/  \\/  \\ \\@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@|  | /\\ | /\\ | /\\ | /\\ | /\\ | /\\ | |@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@|  |/  \\|/  \\|/  \\|/  \\|/  \\|/  \\| |@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@|  |\\__/|\\__/|\\__/|\\__/|\\__/|\\__/| |@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@\\  \\  /\\  /\\  /\\  /\\  /\\  /\\  /  /@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@\\  \\/  \\/  \\/  \\/  \\/  \\/  \\/  /@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@\\,,,,,,,,,,,,,,,,,,,,,,,,,,,/@@@@@@@@@@@@@@@@@@@@
</span>`;
            printHTML(mkAgent);
            await new Promise(r => setTimeout(r, 150));
            output.innerHTML = ''; setTimeout(() => document.body.classList.remove('shake-screen'), 400);
        } else {
          if (log.text) { printHTML(`<span class="system-msg">${log.text}</span>`); playSound('type'); } 
          else { printHTML("<br>"); }
          await new Promise(r => setTimeout(r, log.delay));
        }
      }
      
      const ascii = `
  ███████╗ ██████╗██╗██████╗ ███╗   ██╗███████╗████████╗
  ██╔════╝██╔════╝██║██╔══██╗████╗  ██║██╔════╝╚══██╔══╝
  ███████╗██║     ██║██████╔╝██╔██╗ ██║█████╗     ██║   
  ╚════██║██║     ██║██╔═══╝ ██║╚██╗██║██╔══╝     ██║   
  ███████║╚██████╗██║██║     ██║ ╚████║███████╗   ██║   
  ╚══════╝ ╚═════╝╚═╝╚═╝     ╚═╝  ╚═══╝╚══════╝   ╚═╝   
`;
      playSound('success');
      printText(ascii.replace(/^\n/, ''), 'ascii-art');
      printHTML("<span class='warning-msg'>[ DIRECTIVE: SECURE. CONTAIN. PROTECT. ]</span>");
      printHTML("Type <span class='key-color'>help</span> for commands, or <span class='key-color'>scp [ITEM_NUMBER]</span> to query the database.\n<br>");
      
      inputLine.style.display = 'flex';
      inputField.focus({preventScroll: true});
      scrollToBottom();
    }

    // --- INPUT HANDLING ---
    inputField.addEventListener('input', () => {
      initAudio(); playSound('type');
      cmdDisplay.textContent = inputField.value;
      cursorEl.classList.add('typing'); clearTimeout(typingTimer);
      typingTimer = setTimeout(() => cursorEl.classList.remove('typing'), 500);
    });

    inputField.addEventListener('keydown', async (e) => {
      initAudio();
      
      if (inPager) {
        e.preventDefault(); playSound('type');
        if (e.key.toLowerCase() === 'q' || e.key === 'Escape') closePager();
        else if (e.key === 'ArrowDown') nanoContent.scrollTop += 50;
        else if (e.key === 'ArrowUp') nanoContent.scrollTop -= 50;
        else if (e.key === 'PageDown' || e.key === ' ') nanoContent.scrollTop += nanoContent.clientHeight - 40;
        else if (e.key === 'PageUp') nanoContent.scrollTop -= nanoContent.clientHeight - 40;
        return;
      }

      if (e.key === 'Enter') {
        playSound('enter');
        const rawCmd = inputField.value; const cmd = rawCmd.trim();
        inputField.value = ''; cmdDisplay.textContent = '';
        printHTML(`${getPromptHTML()} <span style="color: #fff;">${escapeHTML(rawCmd)}</span>`);
        
        if (cmd) {
          commandHistory.push(cmd); historyIndex = commandHistory.length;
          let args = cmd.split(' '); let baseCmd = args[0].toLowerCase();
          
          if (aliases[baseCmd]) {
             const resolvedAlias = aliases[baseCmd].split(' ');
             baseCmd = resolvedAlias[0]; args = resolvedAlias.concat(args.slice(1));
          } else if (/^\d+$/.test(baseCmd)) { args.unshift('scp'); baseCmd = 'scp'; }
          
          if (commands[baseCmd]) await commands[baseCmd].action(args.slice(1));
          else { playSound('error'); printHTML(`<span class="error-msg">bash: ${escapeHTML(baseCmd)}: command not found</span>`); }
        }
        printHTML(''); scrollToBottom();

      } else if (e.key === 'ArrowUp') {
        e.preventDefault(); playSound('type');
        if (historyIndex > 0) { historyIndex--; inputField.value = commandHistory[historyIndex]; cmdDisplay.textContent = inputField.value; }
      } else if (e.key === 'ArrowDown') {
        e.preventDefault(); playSound('type');
        if (historyIndex < commandHistory.length - 1) { historyIndex++; inputField.value = commandHistory[historyIndex]; cmdDisplay.textContent = inputField.value; } 
        else { historyIndex = commandHistory.length; inputField.value = ''; cmdDisplay.textContent = ''; }
      } else if (e.key === 'Tab') {
        e.preventDefault(); playSound('type');
        const currentCmd = inputField.value.toLowerCase();
        const availableCmds = Object.keys(commands).concat(Object.keys(aliases));
        const matches = availableCmds.filter(c => c.startsWith(currentCmd));
        if (matches.length === 1) { inputField.value = matches[0]; cmdDisplay.textContent = inputField.value; } 
        else if (matches.length > 1 || currentCmd === '') {
          printHTML(`${getPromptHTML()} <span style="color: #fff;">${escapeHTML(inputField.value)}</span>`);
          printText((matches.length > 0 ? matches : availableCmds).join('   '), 'key-color');
          printHTML(''); scrollToBottom();
        }
      }
    });

    // --- GLOBAL EVENTS ---
    document.addEventListener('click', () => {
      initAudio(); if (window.getSelection().toString() === '' && !inPager) inputField.focus({ preventScroll: true });
    });
    window.addEventListener('resize', () => { if (!inPager) scrollToBottom(); });
    
    // STARTUP
    window.addEventListener('load', () => {
      const initBtn = document.getElementById('init-overlay');
      initBtn.addEventListener('click', () => {
        initAudio(); initBtn.remove(); runBootSequence(true);
      });
    });
    
  </script>
</body>
</html>
