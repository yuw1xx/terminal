<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Terminal - Linux Kernel 5.15</title>
    <style>
        :root {
            --bg-color: #0c0c0c;
            --fg-color: #cccccc;
            --prompt-user: #11a143;
            --prompt-path: #3b78ff;
            --dir-color: #3b78ff;
            --file-color: #cccccc;
            --exec-color: #11a143;
            --error-color: #e74856;
            --font-family: 'Cascadia Code', 'Ubuntu Mono', 'Courier New', monospace;
            --font-size: 15px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body, html {
            height: 100%; width: 100%;
            background-color: var(--bg-color);
            color: var(--fg-color);
            font-family: var(--font-family);
            font-size: var(--font-size);
            overflow: hidden;
            position: relative;
        }

        #terminal {
            height: 100%; width: 100%;
            padding: 15px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #444 transparent;
            display: flex;
            flex-direction: column;
        }

        #terminal::-webkit-scrollbar { width: 6px; }
        #terminal::-webkit-scrollbar-thumb { background-color: #444; border-radius: 3px; }

        .output-line {
            margin-bottom: 2px;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.3;
        }

        .input-line {
            display: none; /* Hidden during boot */
            align-items: center;
            margin-top: 5px;
            flex-wrap: wrap;
        }

        .prompt { font-weight: bold; margin-right: 8px; white-space: pre; }
        .prompt .user { color: var(--prompt-user); }
        .prompt .path { color: var(--prompt-path); }

        #cmd-input {
            flex-grow: 1;
            background: transparent;
            border: none;
            color: inherit;
            font-family: inherit;
            font-size: inherit;
            outline: none;
            min-width: 50%;
        }

        .dir { color: var(--dir-color); font-weight: bold; }
        .exec { color: var(--exec-color); font-weight: bold; }
        .error { color: var(--error-color); }
        .boot-log { color: #aaa; font-size: 13px; }
        .success { color: #11a143; }

        /* Full-screen UI components */
        #top-overlay, #nano-editor, #cmatrix-overlay {
            display: none;
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg-color);
            z-index: 100;
        }

        #top-overlay { padding: 10px; flex-direction: column; }
        #cmatrix-overlay { z-index: 200; background-color: black; }

        /* Nano Specifics */
        #nano-editor { flex-direction: column; }
        #nano-header {
            background-color: #ddd; color: #000;
            padding: 2px 10px; font-weight: bold; display: flex; justify-content: space-between;
        }
        #nano-footer {
            background-color: #ddd; color: #000;
            padding: 5px 10px; font-weight: bold; display: flex; gap: 20px; flex-wrap: wrap;
        }
        #nano-textarea {
            flex-grow: 1; background: transparent; color: inherit;
            border: none; padding: 10px; font-family: inherit; font-size: inherit;
            outline: none; resize: none;
        }

        /* Nano Command prompt overlay */
        #nano-prompt {
            display: none; background-color: var(--bg-color); color: var(--fg-color);
            padding: 5px 10px; border-top: 1px solid #444; align-items: center;
        }
        #nano-prompt-text { margin-right: 10px; }
        #nano-prompt-input { background: transparent; border: none; color: inherit; outline: none; font-family: inherit; flex-grow: 1;}

        .ls-l-table { display: table; margin: 5px 0; }
        .ls-l-row { display: table-row; }
        .ls-l-cell { display: table-cell; padding-right: 15px; white-space: pre; }
    </style>
</head>
<body>

    <div id="terminal">
        <div id="output"></div>
        <div class="input-line" id="input-container">
            <span class="prompt" id="prompt"></span>
            <input type="text" id="cmd-input" autocomplete="off" spellcheck="false" autofocus>
        </div>
    </div>

    <!-- Nano Editor -->
    <div id="nano-editor">
        <div id="nano-header">
            <span>GNU nano 5.4</span>
            <span id="nano-filename">New Buffer</span>
            <span></span>
        </div>
        <textarea id="nano-textarea" spellcheck="false"></textarea>
        <div id="nano-prompt">
            <span id="nano-prompt-text"></span>
            <input type="text" id="nano-prompt-input" autocomplete="off" spellcheck="false">
        </div>
        <div id="nano-footer">
            <span>^G Get Help</span> <span>^O Write Out</span> <span>^W Where Is</span> <span>^K Cut Text</span>
            <span>^X Exit</span> <span>^R Read File</span> <span>^\\ Replace</span> <span>^U Uncut Text</span>
        </div>
    </div>

    <!-- Top Overlay -->
    <div id="top-overlay">
        <div id="top-content" style="white-space: pre; font-family: monospace;"></div>
    </div>

    <!-- CMatrix Overlay -->
    <canvas id="cmatrix-overlay"></canvas>

    <script>
        // --- System Internals ---
        const startTime = Date.now();
        let env = { USER: 'guest', HOME: '/home/guest', PWD: '/home/guest', SHELL: '/bin/bash', PATH: '/bin:/usr/bin' };
        let currentPath = ['home', 'guest'];
        let cmdHistory = [];
        let historyIndex = -1;
        let processes = [
            { pid: 1, name: 'systemd', user: 'root', cpu: 0.1, mem: 1.2 },
            { pid: 42, name: 'bash', user: 'guest', cpu: 0.0, mem: 0.5 },
            { pid: 502, name: 'sshd', user: 'root', cpu: 0.0, mem: 0.2 }
        ];

        // --- Virtual File System ---
        function createNode(type, content = '', owner = 'root', perms = null) {
            return {
                type, content, owner,
                group: owner === 'root' ? 'root' : 'users',
                perms: perms || (type === 'dir' ? 'drwxr-xr-x' : (type === 'exec' ? '-rwxr-xr-x' : '-rw-r--r--')),
                date: new Date().toLocaleString('en-US', { month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' }).replace(',', ''),
                size: type === 'dir' ? 4096 : content.length
            };
        }

        const vfs = createNode('dir', {
            'bin': createNode('dir', {
                'bash': createNode('exec', 'ELF...', 'root'),
                'ls': createNode('exec', 'ELF...', 'root')
            }),
            'etc': createNode('dir', {
                'hostname': createNode('file', 'webos-server\n'),
                'passwd': createNode('file', 'root:x:0:0:root:/root:/bin/bash\nguest:x:1000:1000:guest:/home/guest:/bin/bash\n'),
                'motd': createNode('file', 'Welcome to WebOS Linux 5.15 LTS\n* Documentation: https://github.com/webos\n')
            }),
            'home': createNode('dir', {
                'guest': createNode('dir', {
                    'documents': createNode('dir', {
                        'notes.txt': createNode('file', 'Remember to fix the JS VFS logic tomorrow.', 'guest')
                    }, 'guest'),
                    'script.py': createNode('file', 'print("Hello from Python simulation")', 'guest')
                }, 'guest')
            }),
            'proc': createNode('dir', {}), // Dynamic
            'var': createNode('dir', { 'log': createNode('dir', { 'syslog': createNode('file', 'Initial boot complete.\n') }) })
        });

        // --- UI Logic ---
        const outputEl = document.getElementById('output');
        const inputEl = document.getElementById('cmd-input');
        const promptEl = document.getElementById('prompt');
        const inputContainer = document.getElementById('input-container');
        const terminal = document.getElementById('terminal');

        function print(text, className = '') {
            const div = document.createElement('div');
            div.className = 'output-line ' + className;
            div.innerHTML = text.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>');
            outputEl.appendChild(div);
            terminal.scrollTop = terminal.scrollHeight;
        }

        function printHTML(html, className = '') {
            const div = document.createElement('div');
            div.className = 'output-line ' + className;
            div.innerHTML = html;
            outputEl.appendChild(div);
            terminal.scrollTop = terminal.scrollHeight;
        }

        function updatePrompt() {
            const pathStr = '/' + currentPath.join('/');
            const displayPath = pathStr.startsWith(env.HOME) ? '~' + pathStr.slice(env.HOME.length) : (pathStr || '/');
            promptEl.innerHTML = `<span class="user">${env.USER}@webos</span>:<span class="path">${displayPath}</span>${env.USER === 'root' ? '#' : '$'}`;
        }

        // --- Path Resolution ---
        function resolvePath(pathStr) {
            if (!pathStr) return [...currentPath];
            if (pathStr === '~') return env.HOME.split('/').filter(x => x);
            let parts = pathStr.split('/').filter(p => p !== '');
            let target = pathStr.startsWith('/') ? [] : [...currentPath];

            for (let p of parts) {
                if (p === '.') continue;
                if (p === '..') { if (target.length > 0) target.pop(); }
                else target.push(p);
            }
            return target;
        }

        function getNode(pathArr) {
            let curr = vfs;
            for (let p of pathArr) {
                if (!curr || curr.type !== 'dir' || !curr.content[p]) return null;
                curr = curr.content[p];
            }
            return curr;
        }

        function getParentNodeAndName(pathArr) {
            if (pathArr.length === 0) return { parent: null, name: '' };
            let parentPath = pathArr.slice(0, -1);
            let name = pathArr[pathArr.length - 1];
            return { parent: getNode(parentPath), name: name };
        }

        // --- Command System ---
        const commands = {
            help: () => {
                return `GNU bash, version 5.1.16(1)-release (x86_64-webos-linux-gnu)
Available commands:
  help      cd        ls        pwd       cat       echo
  mkdir     touch     rm        nano      ps        top
  su        whoami    date      uptime    ping      curl
  clear     history   neofetch  apt       cmatrix

Pro-tips:
- Use Up/Down arrows for command history.
- Use Tab to auto-complete commands and file names.
- Try running 'cmatrix' for a cool effect!`;
            },
            clear: () => { outputEl.innerHTML = ''; return null; },
            pwd: () => '/' + currentPath.join('/'),
            whoami: () => env.USER,
            date: () => new Date().toString(),
            history: () => cmdHistory.map((c, i) => `  ${i+1}  ${c}`).join('\n'),
            uptime: () => {
                const diff = Math.floor((Date.now() - startTime) / 1000);
                return `up ${Math.floor(diff / 60)} minutes, 1 user, load average: 0.01, 0.05, 0.10`;
            },
            ls: (args) => {
                const long = args.includes('-l');
                const all = args.includes('-a');
                const target = resolvePath(args.find(a => !a.startsWith('-')) || '');
                const node = getNode(target);
                if (!node || node.type !== 'dir') return `<span class="error">ls: cannot access: No such directory</span>`;
                
                let keys = Object.keys(node.content);
                if (all) keys = ['.', '..', ...keys];
                keys.sort();

                if (long) {
                    let html = '<div class="ls-l-table">';
                    html += `<div class="ls-l-row"><span class="ls-l-cell">total ${keys.length * 4}</span></div>`;
                    keys.forEach(k => {
                        const item = (k === '.' || k === '..') ? node : node.content[k];
                        const cName = item.type === 'dir' ? 'dir' : (item.type === 'exec' ? 'exec' : 'file');
                        html += `<div class="ls-l-row">
                            <span class="ls-l-cell">${item.perms}</span>
                            <span class="ls-l-cell">${item.owner}</span>
                            <span class="ls-l-cell">${item.group}</span>
                            <span class="ls-l-cell" style="text-align:right">${item.size}</span>
                            <span class="ls-l-cell">${item.date}</span>
                            <span class="ls-l-cell ${cName}">${k}</span>
                        </div>`;
                    });
                    return html + '</div>';
                }
                return keys.map(k => {
                    const item = (k === '.' || k === '..') ? node : node.content[k];
                    const cName = item.type === 'dir' ? 'dir' : (item.type === 'exec' ? 'exec' : 'file');
                    return `<span class="${cName}">${k}</span>`;
                }).join('  ');
            },
            cd: (args) => {
                const target = resolvePath(args[0] || '~');
                const node = getNode(target);
                if (node && node.type === 'dir') { currentPath = target; updatePrompt(); return null; }
                return `<span class="error">cd: ${args[0]}: No such directory</span>`;
            },
            cat: (args) => {
                if (!args[0]) return `<span class="error">cat: missing file operand</span>`;
                const node = getNode(resolvePath(args[0]));
                if (!node) return `<span class="error">cat: ${args[0]}: No such file</span>`;
                if (node.type === 'dir') return `<span class="error">cat: ${args[0]}: Is a directory</span>`;
                return node.content;
            },
            echo: (args) => args.join(' '),
            mkdir: (args) => {
                if (!args[0]) return `<span class="error">mkdir: missing operand</span>`;
                const { parent, name } = getParentNodeAndName(resolvePath(args[0]));
                if (!parent || parent.type !== 'dir') return `<span class="error">mkdir: cannot create directory '${args[0]}'</span>`;
                if (parent.content[name]) return `<span class="error">mkdir: cannot create directory '${args[0]}': File exists</span>`;
                parent.content[name] = createNode('dir', {}, env.USER);
                return null;
            },
            touch: (args) => {
                if (!args[0]) return `<span class="error">touch: missing operand</span>`;
                const { parent, name } = getParentNodeAndName(resolvePath(args[0]));
                if (!parent || parent.type !== 'dir') return `<span class="error">touch: cannot touch '${args[0]}'</span>`;
                if (!parent.content[name]) parent.content[name] = createNode('file', '', env.USER);
                else parent.content[name].date = new Date().toLocaleString('en-US', { month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' }).replace(',', '');
                return null;
            },
            rm: (args) => {
                if (!args[0]) return `<span class="error">rm: missing operand</span>`;
                const { parent, name } = getParentNodeAndName(resolvePath(args[0]));
                if (!parent || !parent.content[name]) return `<span class="error">rm: cannot remove '${args[0]}': No such file</span>`;
                if (parent.content[name].type === 'dir' && !args.includes('-r')) return `<span class="error">rm: cannot remove '${args[0]}': Is a directory</span>`;
                delete parent.content[name];
                return null;
            },
            su: (args) => {
                const user = args[0] || 'root';
                print(`Password for ${user}: `); 
                setTimeout(() => {
                    env.USER = user;
                    env.HOME = user === 'root' ? '/root' : '/home/' + user;
                    currentPath = env.HOME.split('/').filter(x => x);
                    updatePrompt();
                    print(`Logged in as ${user}`, 'success');
                }, 800);
                return null;
            },
            ps: () => {
                let out = "  PID TTY          TIME CMD\n";
                processes.forEach(p => out += `${p.pid.toString().padStart(5)} pts/0    00:00:00 ${p.name}\n`);
                return out;
            },
            top: () => {
                const overlay = document.getElementById('top-overlay');
                const content = document.getElementById('top-content');
                overlay.style.display = 'flex';
                inputEl.blur();
                const interval = setInterval(() => {
                    let out = `top - ${new Date().toLocaleTimeString()} up ...\n`;
                    out += `Tasks: ${processes.length} total, 1 running, ${processes.length - 1} sleeping\n`;
                    out += `%Cpu(s): ${ (Math.random() * 2).toFixed(1) } us, 1.2 sy, 0.0 ni, 98.5 id\n\n`;
                    out += `  PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND\n`;
                    processes.forEach(p => {
                        out += `${p.pid.toString().padStart(5)} ${p.user.padEnd(8)} 20   0  162312  24212   1241 S   ${p.cpu.toFixed(1)}   ${p.mem.toFixed(1)}   0:00.01 ${p.name}\n`;
                    });
                    content.innerText = out;
                }, 1000);

                const endTop = (e) => {
                    if (e.key === 'q' || e.key === 'Escape') {
                        clearInterval(interval);
                        overlay.style.display = 'none';
                        window.removeEventListener('keydown', endTop);
                        setTimeout(() => inputEl.focus(), 10);
                    }
                };
                window.addEventListener('keydown', endTop);
                return null;
            },
            ping: (args) => {
                if (!args[0]) return "Usage: ping <host>";
                let count = 0;
                print(`PING ${args[0]} (1.1.1.1) 56(84) bytes of data.`);
                const int = setInterval(() => {
                    print(`64 bytes from 1.1.1.1: icmp_seq=${++count} ttl=58 time=${(Math.random()*20+10).toFixed(1)} ms`);
                    if (count >= 4) {
                        clearInterval(int);
                        print(`--- ${args[0]} ping statistics ---`);
                        print(`4 packets transmitted, 4 received, 0% packet loss`);
                    }
                }, 1000);
                return null;
            },
            curl: (args) => {
                if (!args[0]) return "curl: try 'curl --help' for more information";
                print(`Connecting to ${args[0]}...`);
                setTimeout(() => print(`HTTP/1.1 200 OK\nContent-Type: text/html\n\n&lt;html&gt;&lt;body&gt;Welcome to ${args[0]}&lt;/body&gt;&lt;/html&gt;`), 1200);
                return null;
            },
            neofetch: () => {
                const logo = `<span style="color: var(--prompt-path);">       _,met$$$$$gg.</span>
<span style="color: var(--prompt-path);">    ,g$$$$$$$$$$$$$$$P.</span>
<span style="color: var(--prompt-path);">  ,g$$P"     """Y$$.".</span>
<span style="color: var(--prompt-path);"> ,$$P'              \`$$$.</span>
<span style="color: var(--prompt-path);">',$$P       ,ggs.     \`$$b:</span>
<span style="color: var(--prompt-path);">\`d$$'     ,$P"'   <span style="color: var(--error-color);">.</span>    $$$</span>
<span style="color: var(--prompt-path);"> $$P    